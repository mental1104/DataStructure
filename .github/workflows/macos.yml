name: macOS

on:
  workflow_call: {}
  push:
    branches-ignore:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-test:
    name: ${{ matrix.compiler.name }}-cxx${{ matrix.standard }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        compiler:
          - name: gcc
            cc: gcc
            cxx: g++
          - name: clang
            cc: clang
            cxx: clang++
        standard: [11, 14, 17, 20, 23] # 26
    env:
      CXX_STD: ${{ matrix.standard }}
      GCOV: ${{ matrix.compiler.name == 'clang' && 'llvm-cov gcov' || 'gcov' }}
      COMPILER_KEY: ${{ matrix.compiler.name == 'clang' && 'clangpp' || 'gpp' }}
      COMPILER_LABEL: ${{ matrix.compiler.name == 'clang' && 'clang++' || 'g++' }}
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install gcovr
        run: brew install gcovr

      - name: Ensure llvm-cov available
        run: |
          if command -v llvm-cov >/dev/null 2>&1; then
            echo "llvm-cov available in PATH"
          elif xcrun --find llvm-cov >/dev/null 2>&1; then
            echo "llvm-cov available via xcrun"
          else
            brew install llvm
            echo "$(brew --prefix llvm)/bin" >> "$GITHUB_PATH"
          fi

      - name: Configure CMake
        run: |
          build_dir="build-${{ matrix.compiler.name }}-cxx${{ matrix.standard }}"
          cmake -S . -B "$build_dir" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=${{ matrix.compiler.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.compiler.cxx }} \
            -DCMAKE_CXX_STANDARD=${{ matrix.standard }} \
            -DCOVERAGE=ON -DENABLE_COVERAGE=ON

      - name: Build
        run: cmake --build "build-${{ matrix.compiler.name }}-cxx${{ matrix.standard }}" --config Release --parallel

      - name: Run coverage
        run: cmake --build "build-${{ matrix.compiler.name }}-cxx${{ matrix.standard }}" --config Release --target coverage

      - name: Export coverage.xml (never fail)
        if: always()
        continue-on-error: true
        run: |
          set +e
          rm -f coverage.xml
          build_dir="build-${{ matrix.compiler.name }}-cxx${{ matrix.standard }}"

          if [ -d "$build_dir" ]; then
            gcovr -r . "$build_dir" \
              --object-directory "$build_dir" \
              --gcov-executable "$GCOV" \
              --xml-pretty -o coverage.xml \
              --filter '^src/include' \
              --exclude '(^|.*/)(test|bench|demo|external|gtest|lib|thirdparty|overlay)/' \
              --exclude 'src/include/print/.*' \
              --exclude '/usr/include/.*' \
              --exclude-directories '.*/build-(asan|tsan|ubsan|msan).*' \
              --exclude-directories '.*/CMakeFiles/.*' \
              --gcov-exclude '.*CMakeFiles/.*' \
              --gcov-ignore-parse-errors \
              --gcov-ignore-errors source_not_found \
              --print-summary
          fi

          if [ ! -f coverage.xml ]; then
            printf '%s\n' \
              "<?xml version='1.0' encoding='UTF-8'?>" \
              "<!DOCTYPE coverage SYSTEM 'http://cobertura.sourceforge.net/xml/coverage-04.dtd'>" \
              "<coverage line-rate=\"0.0\" branch-rate=\"0.0\" lines-covered=\"0\" lines-valid=\"0\" branches-covered=\"0\" branches-valid=\"0\" complexity=\"0.0\" timestamp=\"0\" version=\"placeholder\">" \
              "  <sources><source>.</source></sources>" \
              "  <packages/>" \
              "</coverage>" \
              > coverage.xml
          fi

      - name: Extract cov.json (never fail)
        if: always()
        continue-on-error: true
        run: |
          set +e
          python3 tools/ci/extract_coverage_cpp.py \
            --os macos \
            --compiler "${COMPILER_LABEL}" \
            --cxx-std ${{ matrix.standard }} \
            --out cov.json || true

          if [ ! -f cov.json ]; then
            python3 -c "import json,os;obj={'os':'macos','compiler':os.getenv('COMPILER_LABEL','unknown'),'cxx_std':int('${{ matrix.standard }}'),'line_pct':0.0,'source':'placeholder','sha':os.getenv('GITHUB_SHA',''),'run_id':os.getenv('GITHUB_RUN_ID',''),'status':'placeholder'};json.dump(obj,open('cov.json','w',encoding='utf-8'),ensure_ascii=False,indent=2)"
          fi

      - name: Stash coverage files (unique path)
        if: always()
        continue-on-error: true
        run: |
          set +e
          key="macos-${COMPILER_KEY}-cxx${{ matrix.standard }}"
          mkdir -p "_cov/cpp/${key}"
          cp -f cov.json "_cov/cpp/${key}/cov.json" 2>/dev/null || true
          cp -f coverage.xml "_cov/cpp/${key}/coverage.xml" 2>/dev/null || true

      - name: Upload coverage artifacts (unique)
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: cpp-cov-macos-${{ env.COMPILER_KEY }}-cxx${{ matrix.standard }}
          path: _cov
          retention-days: 7
          if-no-files-found: warn
